---
title: "Breeding ecology parameterization based on FdN data"
author: "Vic Quennessen, viquennessen@gmail.com"
date: "2025-11-19"
output: pdf_document
sansfont: Calibri Light
classoption: 12pt
header-includes:
  - \usepackage{graphicx}
  - \graphicspath{{figures/}}
  - \usepackage{stackengine}
  - \usepackage{setspace}
  - \usepackage{caption}
  - \usepackage{titling}
  - \setlength{\droptitle}{-1.1in}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(chunk = function(x, options) {
  if (!is.null(options$size)) {
    paste0('\n \\', options$size, '\n\n', x, '\n\n \\small')
  } else x
})
```


```{r, echo = FALSE, warning = FALSE, message = FALSE}
# load libraries
library(dplyr)
library(readr)
library(ggplot2)
library(tidyverse)
library(patchwork)
library(e1071)
library(fitdistrplus)
library(extraDistr)
library(goft)
library(bbmle)

# load data
# TO DO: edit path to file as needed
BSR_Info_VIC_2025_MaleContribution <- read_csv(
  "~/Projects/iliketurtles3/data/BSR_Info_VIC_2025 - MaleContribution.csv")

# clean up data
clean_data <- BSR_Info_VIC_2025_MaleContribution %>%
  # don't need empty column or notes
  dplyr::select(mom_nest_combo, dad, hatchling_count, NestTotalHatchCount, 
                propdadcontribute, LowNestSampleSize) %>%
  # filter out rows with low nest sample sizes
  filter(LowNestSampleSize == 'No') %>%
  # extract season
  mutate(Season = substring(mom_nest_combo, 10, 11)) %>%
  # extract mom ID
  mutate(Female = substring(mom_nest_combo, 5, 8)) %>%
  # extract nest ID
  mutate(Nest = substring(mom_nest_combo, 13, 16)) 
```


\textbf{Model parameters to estimate:}
\begin{enumerate}
\item distribution of the number of males that females mate with
\item the way that multiple males fertilize offspring in a clutch
\item the remigration interval for resident males
\end{enumerate}

\textbf{Overview of reproductive sub-model:}

For each sex, age class, year, and simulation, I am tracking the number of individuals as well as the mean, median, and variance of genotypes (which are tracked at the sex and age class level). For each year and simulation, I am also tracking the operational sex ratio of the population.

For each breeding season, after survival and maturity are stepped forward in the population dynamics sub-model, the number of adults that become available to breed are the sum of successful draws from a binomial distribution with probability equal to one over the remigration interval (Q3). For example, if there are 5 females with a remigration interval of 5 years, I would take 5 draws from a binomial distribution with probability equal to 1/5 = 0.2. 

Once I have the number of available males and females, I can calculate the operational sex ratio (number of males / number of all available adults), and use the mating function to translate that to reproductive success.

The number of actually breeding females is then the sum of draws from a binomial distribution with the probability of successfully finding a mate equal to the reproductive success. For each female who breeds, she will mate with a certain number of males (Q1), to be drawn from a 'breeding pool', where each male is represented X times based on the minimum OSR for each mating function. For example, for the mating function with a minimum OSR of 0.05, each male can theoretically mate with 19 females, so there will be 19 copies of each male in the breeding pool. 

Then, she will lay a number of clutches and a number of eggs for each clutch drawn from the distributions of clutches per females and eggs per clutch from our FdN field data. 

For each clutch, the maternal genotype is based on the breeding female, and eggs are assigned paternal genotypes based on the pattern of multiple male fertilization (Q2). These are used to calculate the offspring genotypes, and then the offspring phenotypes. Evolvable traits are the midpoints of the temperature-mediated emergence success and the thermal reaction norm (i.e. the pivotal temperature). Then, offspring survive based on temperature-mediated emergence success and are assigned sex based on the clutch temperature and the thermal reaction norm. 

I'm only using data from clutches with a high nest sample size, but I am retaining data from Season 1 since the partial season should not affect how many males a female mates with (assuming all males are represented in all clutches of females they mate with), the way that ranked males fertilize offspring in individual clutches, or skew the remigration interval analysis in the way that we'd expect (i.e. to have migrating males that we'd miss observing). 


\newpage

# 1. how many males do females mate with in one season?

In order to more accurately model evolution with maternal and paternal genotypes, I will build a 'breeding pool' of males, where each male will be represented X times, where X is the average number of females that males can mate with, rounded to the nearest integer, dependent upon the mating function. Then, for each female, I need to be able to determine how many males she will mate with to draw that many unique males from the breeding pool. 

```{r, echo = FALSE, results = 'hide'}

males_per_female <- clean_data %>%
  dplyr::select(Season, Female) %>%
  group_by(Season, Female) %>%
  mutate(nMales = n()) 

round(prop.table(table(males_per_female$nMales)), 2)
#    1    2    3    4    6    7 
# 0.09 0.30 0.12 0.36 0.08 0.05 

summary(males_per_female$nMales) 
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  1.000   2.000   3.000   3.315   4.000   7.000 

# variance
var(males_per_female$nMales)
# 2.437978

# standard deviation
sd(males_per_female$nMales)
# 1.561403

# skew
skewness(males_per_female$nMales)
# 0.6068969

# kurtosis ('fatness' of tails)
kurtosis(males_per_female$nMales)
# -0.1987063
```

\begin{table}[h]
\begin{tabular}{llllllll}
\textbf{Number of males} & 1 & 2 & 3 & 4 & 5 & 6 & 7 \\
\hline
\textbf{Count} & 13 & 44 & 18 & 52 & 0 & 12 & 7 \\
\textbf{Proportion} & 0.09 & 0.30 & 0.12 & 0.36 & 0 & 0.08 & 0.05
\end{tabular}
\end{table}

\textbf{Table 1. Number of males that females mated with in one season}
\newline
\newline

\begin{table}[h]
\begin{tabular}{lllllllllll}
\textbf{Min} & \textbf{1st Q} & \textbf{Median} & \textbf{Mean} & \textbf{3rd Q} & \textbf{Max} & \textbf{Variance} & \textbf{SD} & \textbf{Skew} & \textbf{Kurtosis} \\
\hline
1.000 & 2.000 & 3.000 & 3.315 & 4.000 & 7.000 & 2.438 & 1.561 & 0.607 & -0.199 \\
\end{tabular}
\end{table}

\textbf{Table 2. Summary statistics of number of males females mated with}
\newline
\newline
\newline

```{r, echo = FALSE, fig.height = 4}
ggplot(data = males_per_female, 
       aes(x = nMales)) +
  geom_histogram(aes(y = after_stat(count)/sum(after_stat(count))), 
                 bins = 7, col = 'black', fill = 'cyan3') +
  theme_bw() +
  xlab('\n Number of males FdN females mated with in one season') +
  ylab('Proportion \n') +
  scale_x_continuous(breaks = c(1:7))
```
\textbf{Figure 1. Density histogram of number of males females mated with per season}


\newpage

## why fit a model?

we can't just use the proportions of females that mated with 1 - 7 males since 
sample sizes are small, and no recorded female mated with 5 males. 

```{r, echo = FALSE, eval = FALSE, warning = FALSE}
# discrete gamma distribution
fit_dgamma <- fitdist(males_per_female$nMales, 'gamma', discrete = TRUE)
summary(fit_dgamma)

# poisson distribution
fit_poisson <- fitdist(males_per_female$nMales, 'pois')
summary(fit_poisson)

# negative binomial distribution
fit_negative_binomial <- fitdist(males_per_female$nMales, 'nbinom')
summary(fit_negative_binomial)

# geometric distribution
fit_geometric <- fitdist(males_per_female$nMales, 'geom')
summary(fit_geometric)
```

\begin{table}[h]
\begin{tabular}{lllll}
\textbf{Distribution} & \textbf{Log likelihood} & \textbf{AIC} & \textbf{BIC} \\
\hline
discrete gamma & -263.2182 & 530.4363 & 536.4035 \\
poisson & -270.5726 & 543.1452 & 546.1288 \\
negative binomial & -270.5726  & 545.1452 & 551.1124 \\
geometric & -341.0678 & 684.1356 & 687.1193  
\end{tabular}
\end{table}

\textbf{Table 3. Model fits} 
\newline
The discrete gamma distribution had the best fit with the lowest log likelihood, AIC, and BIC values. 
\newline

## model output:

```{r, echo = FALSE, warning = FALSE, fig.height = 4, size = 'small'}

# model with fitted discrete gamma distribution
fit_dgamma <- fitdist(males_per_female$nMales, 'gamma', discrete = TRUE)

# estimates for shape and rate parameters for discrete gamma distribution
print('coefficients:')
coef(summary(fit_dgamma))

# plot data (black) vs. fitted discrete gamma distribution (red)
plot(fit_dgamma)
```

\textbf{Figure 2. Discrete gamma model fit for the number of males females mate with in one season}

Black lines indicate the density of males females mated with in our FdN dataset, while red lines indicate the predicted density based on the discrete gamma model fit to the data. 

\newpage

## given this discrete model...

If we assume that females can mate with up to 10 males (i.e. we assume that we did not observe all contributing males in our dataset), then we can predict the proportion of females that would mate with 1 to 10 males. Unfortunately, the discrete gamma distribution has a tail that cannot be incorporated into a discrete number of potential male values, so the sum of the weights does not add up to 1. In order to use these probabilities in my model, I have to normalize the weights to add up to one. \newline 


```{r, echo = FALSE, results = 'hide'}
# max number of males females can mate with (7 in data)
max_males <- 10

# weighted probabilities for females mating with 1 - 7 males
weightedP <- ddgamma(1:max_males, 
                     shape = fit_dgamma$estimate['shape'], 
                     rate = fit_dgamma$estimate['rate'])

raw_weights <- round(weightedP, 3)
#  0.183 0.272 0.230 0.146 0.078 0.037 0.016 0.007 0.003 0.001

total_sum <- sum(raw_weights)
# 0.973

# normalize weights so that they add up to 1
# this assumes we can't have females mating with more than max_males males)
# to adjust this assumption, adjust max_males values 
weights_to_use <- round(weightedP / sum(weightedP), 3)
probability_of_mating_with_n_Males <- data.frame(number_of_males = 1:max_males, 
                                                 model_weights = raw_weights,
                                                 normalized_weights = weights_to_use)

probability_of_mating_with_n_Males
```

\begin{center}
\setlength{\fboxsep}{10pt}
\fbox{
\begin{minipage}{35em}
\begin{center}
\setstretch{1.75}
{\fontsize{13}{10}\selectfont
\begin{tabular}{llll}
\textbf{Number of males} & \textbf{Model weight} & \textbf{Normalized weight} \\
\hline
1 &  0.183 & 0.188 \\
2 &  0.272 & 0.280 \\
3 &  0.230 & 0.236 \\
4 &  0.146 & 0.150 \\
5 &  0.078 & 0.080 \\
6 &  0.037 & 0.038 \\
7 &  0.016 & 0.017 \\
8 &  0.007 & 0.007 \\
9 &  0.003 & 0.003 \\
10 & 0.001 & 0.001 \\
\hline
\textbf{Sum} & 0.973 & 1.000
\end{tabular}
}
\end{center}
{\fontsize{13}{10}\selectfont
\bigskip
\textbf{Table 4.} Weighted probabilities for females to mate with 1 to 10 males in any given breeding season.}
\end{minipage}
}
\end{center}


\newpage

# 2. how do multiple males fertilize nests?

Within each clutch, do males fertilize offspring randomly, such that each male has the same probability of fertilizing any individual offspring? And do those probabilities change as the total number of contributing males changes?

```{r, echo = FALSE, results = 'hide'}
contributions <- clean_data %>%
  group_by(Season, Female, Nest) %>%
  mutate(nMales = n()) %>%
  group_by(Season, Female, Nest, nMales) %>%
  mutate(Rank = rank(desc(propdadcontribute), ties.method = 'first')) %>%
  rbind(data.frame(mom_nest_combo = NA, 
                   dad = NA, 
                   hatchling_count = NA, 
                   NestTotalHatchCount = NA, 
                   propdadcontribute = NA, 
                   LowNestSampleSize = NA,
                   Season = NA, 
                   Female = NA, 
                   Nest = NA, 
                   nMales = NA, 
                   Rank = c(8:10)))
```


```{r, echo = FALSE, fig.height = 4}
ggplot(data = contributions %>% filter(Rank < 8), 
       aes(x = factor(Rank), 
           y = propdadcontribute,
           fill = factor(nMales))) +
  geom_boxplot() +
  labs(fill = 'total number \n of males \n contributing') +
  ggtitle('Fertilization contributions by Rank (Rank 1 = dominant father)') +
  xlab('Rank')

```

\textbf{Figure 3. Fertilization contributions organized by father 'rank'}

Where rank indicates proportion of offspring fertilized by the $r^{th}$ most dominant father, i.e. Rank 1 indicates the father that fertilized the most offspring sampled from that clutch. Per this data, it looks like the total number of contributing fathers does matter, but samples sizes are too small to extrapolate the effect, so the model was fit to grouped data where only Rank mattered. 

\newpage

## model fit

I chose to use a power law because mechanistically it makes sense that for the first male turtle, a certain proportion of eggs will be fertilized. For the second male, a certain proportion of what is left, and for the third male and so on it will always be a proportion of what eggs are left to fertilize, which can easily be quantified using a power rule with a negative exponent. 

Power law: $y(x) = a \cdot p^{-x}$

```{r, echo = FALSE, size = 'small'}

# turtles work like gravitational waves - jerry sun
# power law
fit_power <- lm(log(propdadcontribute) ~ log(Rank), 
                data = contributions)

print('coefficients:')
summary(fit_power)$coefficients

print('adjusted R^2:')
summary(fit_power)$adj.r.squared
```

Where the intercept $a = exp(-0.376) = 0.687$ and the exponent $x = -1.710$:

\begin{center}
\setlength{\fboxsep}{10pt}
\fbox{
{\fontsize{13}{10}\selectfont
$\displaystyle Proportion\ father\ contributes(Rank) = 0.687 \cdot Rank^{-1.710}$}
}
\end{center}

\bigskip
\bigskip

## model predictions

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5}
test.power <- data.frame(Rank = 1:max_males, 
                         Fit = exp(fit_power$coefficients[[1]])*c(1:max_males)^(
                           fit_power$coefficients[[2]]))

ggplot(data = contributions, 
       aes(x = factor(Rank), 
           y = propdadcontribute,
           fill = factor(nMales))) +
  geom_boxplot() +
  labs(fill = 'total number \n of males \n contributing') +
  ggtitle('Fertilization contributions by Rank (Rank 1 = dominant father)') +
  geom_point(inherit.aes = FALSE, 
             data = test.power, aes(x = Rank, y = Fit), col = 'red', size = 3) +
  xlab('Rank')
```

\textbf{Figure 4. Power law model fit to paternal fertilization contributions organized by father 'rank'}

\bigskip
\bigskip
\textit{Turtles work like gravitational waves! - Jerry}

\newpage

# 3. how often do males remigrate

## male remigration interval used in Chapter 2: 1.47 (years)

for male green turtles at Atol das Rocas (Grossman et al., 2019)

https://www.int-res.com/abstracts/meps/v609/p197-207/


## FdN genetic data

\includegraphics[width=1\textwidth]{C://Users/Vic/Documents/Projects/iliketurtles3/figures/UpdatedMalePresence.png}


\textbf{Figure 4. FdN male remigration data}

Original data, obtained from Dr. Lisa Komoroske (lkomoroske@umass.edu) on Thursday October 9, 2025. Note: "...Estefany made this upsetR graph for Mariana for an upcoming talk, helps visualize the observed remigration interavl a bit for the males (again, keep in mind the difference in sampling effort in S3 and S4, these will need to be normalized to the number of samples run eventually).


\newpage

## fit a binomial model

### marginalized likelihoods over number of 0 and 1 successes

Given a binomial model, or any resident male green turtle, the probability of seeing it $k = 1, 2, 3, or\ 4$ times across $n = 4$ years is equal to:

$$
L(k) = \binom{n}{k} \cdot p^k \cdot (1 - p)^{n - k} 
$$

We know that n = 4, since our data were collected over 4 years, giving 4 chances to observe each male. 66 males were observed in season 4, meaning they could have been observed for all previous seasons. We can assume that those males that were observed more than once were residents. For the remaining 44 males, some unknown number of them were residents and others were transient males. For RM1 resident males observed once, there were RM1 + 22 total resident males observed in our dataset. 

Given probability p, the likelihoods of observing RM1 males once, 14 males twice, 7 males 3 times, and 1 male 4 times is the probability of seeing a resident male $k = 1, 2, 3, 4$ times in any given trial of size $n = 4$ years to the power of the count $c = RM1, 14, 7, 1$ times it was observed:

$$ L(k = 1\ |\ p) = \left( \binom{4}{1} \cdot p^1 \cdot (1-p)^3 \right)^{RM1} $$
$$ ... $$
$$ L(k = 4\ |\ p) = \left( \binom{4}{4} \cdot p^4 \cdot (1-p)^0 \right)^{1} $$

And the total likelihood of seeing all of these is the product of each probability times the number of potential combinations of the order in which they were observed:

$$ L(data\ |\ RM1,p) = \frac{(RM1 + 14 + 7 + 1)!}{RM1!\,14!\,7!\,1!} \cdot \prod_{k=1}^{k=4} P (k\ |\ RM1, p) $$

The conditional likelihood is then the probability of observing RM1 males once out of all males observed (RM1 + 22) given probability p:

$$ P(RM1) = \binom{RM1 + 22}{RM1} \cdot (p(1 - p)^3)^{RM1} \cdot (1 - p(1 - p)^3)^{22} $$
$$ P(RM1 = 1) = \binom{23}{1} \cdot (p(1 - p)^3)^{1} \cdot (1 - p(1 - p)^3)^{22} $$

The marginalized likelihood for each value of RM1 is then the likelihood times the conditional likelihood, and the total likelihood for each probability P is equal to the sum of all the marginalized likelihoods across all potential values of RM1. 

\newpage

```{r, echo = FALSE, results = 'hide'}

analyses <- c('S4 males', 'all males')
total_males <- c(66, 169)
observed234 <- list(c(14, 7, 1),
                    c(23, 7, 1))

probabilities <- seq(from = 0.1, to = 0.9, by = 0.01)

results <- data.frame(Analysis = rep(analyses, each = length(probabilities)),
                      P = rep(probabilities, times = length(analyses)),
                      Likelihood = rep(NA, 
                                       length(analyses) * length(probabilities)))

for (a in 1:length(analyses)) {
  
  def_resident_males <- sum(observed234[[a]])

  maybe_resident_males <- total_males[a] - def_resident_males
  potential_RM1 <- 1:maybe_resident_males
  
  for (p in 1:(length(probabilities))) {
    
    P <- probabilities[p]
    
    marginalized_likelihoods <- c(NULL)
    
    for (rm1 in potential_RM1) {
      
      # probability of seeing data - observed males seen 2, 3, 4 times, plus some N males seen once
      L1 <- (choose(4, 1) * P^1 * (1 - P)^3)^rm1
      L2 <- (choose(4, 2) * P^2 * (1 - P)^2)^observed234[[a]][1]
      L3 <- (choose(4, 3) * P^3 * (1 - P)^1)^observed234[[a]][2]
      L4 <- (choose(4, 4) * P^4 * (1 - P)^0)^observed234[[a]][3]
      
      L_all <- L1 * L2 * L3 * L4
      
      # factorials for combination
      F1 <- factorial(rm1)
      F2 <- factorial(observed234[[a]][1])
      F3 <- factorial(observed234[[a]][2])
      F4 <- factorial(observed234[[a]][3])

      F_all <- F1 * F2 * F3 * F4
      
      likelihood <- factorial(rm1 + def_resident_males)/(F_all) * (L_all)
      
      conditional_likelihood <- choose(rm1 + def_resident_males, rm1) * (
        P*(1 - P)^3)^rm1 * (1 - P*(1 - P)^3)^(def_resident_males)
      
      marginalized_likelihood <- likelihood * conditional_likelihood
      
      marginalized_likelihoods <- c(marginalized_likelihoods, marginalized_likelihood)
      
    }
    
    index <- (a - 1)*length(probabilities) + p
    
    results$Likelihood[index] <- sum(marginalized_likelihoods)
    
  }
  
}

# maximum likelihood binomial probability values
results %>%
  group_by(Analysis) %>%
  filter(Likelihood == max(Likelihood))

```


## should we use all males or only males seen in Season 4?

If we compare the results from analysing only those resident males observed in Season 4 (as opposed to all resident males), the results do not substantially change. The maximum likelihood estimator for P drops from 0.55 to 0.52, but the overall likelihoods are much smaller.
\bigskip
\bigskip

```{r, echo = FALSE, results = 'hide'}

S4P <- results %>%
  filter(Analysis == 'S4 males') %>%
  filter(Likelihood == max(Likelihood)) %>%
  pull(P)

allMP <- results %>%
  filter(Analysis == 'all males') %>%
  filter(Likelihood == max(Likelihood)) %>%
  pull(P) 

to_plot <- results %>%
  mutate(maxL = ifelse(Analysis == 'S4 males', S4P, allMP)) %>%
  rbind(data.frame(Analysis = c('S4 males', 'all males'), 
                   P = rep(NA, 2), 
                   Likelihood = c(3e-4, 4e-6),
                   maxL = c(S4P, allMP)))

fig_labels <- data.frame(Analysis = c('all males', 'S4 males'), 
                         label = c(paste('P = ', allMP, sep = ''), 
                                   paste('P = ', S4P, sep = '')))
```


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5}
ggplot(data = to_plot, 
       aes(x = P, y = Likelihood)) +
  geom_line(aes(x = maxL, y = Likelihood), 
            col = 'blue', lwd = 1) +    
  geom_path(lwd = 1) +
  facet_wrap(vars(Analysis), 
             scales = 'free') +
  xlab('probability of migrating to breeding grounds in any given year') +
  ylab('Likelihood') +
  ggtitle('Maximum likelihood estimation for FdN male probability of migrating') +
  geom_text(data = fig_labels, 
            mapping = aes(x = 0.25, y = Inf, label = label), 
            vjust = 4.5, 
            col = 'blue')

```

\textbf{Figure 5. Likelihood of different probabilities $P$ of FdN resident males mating in any given breeding year}
\newline
\newline

\begin{table}[h]
\begin{tabular}{lllll}
\textbf{Analysis} & \textbf{Log likelihood} & \textbf{Probability} & \textbf{Remigration Interval} \\
\hline
All males & 0.00000378 & 0.52 & 1.92 \\
Season 4 males only & 0.000288 & 0.55 & 1.82
\end{tabular}
\end{table}

\textbf{Table 5. Maximum likelihood estimators for probability P of any one resident FdN male migrating to breeding grounds in any breeding season.}
\newline
\newline
\newline
\newline

\begin{center}
\setlength{\fboxsep}{10pt}
\fbox{
\begin{minipage}{35em}
\begin{center}
\setstretch{1.25}
{\fontsize{13}{10}\selectfont
The final maximum likelihood estimator for the binomial probability of males mating is therefore p = 0.55, with an associated average remigration interval of 1.82 years.}
\end{center}
\end{minipage}
}
\end{center}

\newpage

\textbf{Acknowledgments}
\bigskip
\bigskip

\underline{Research leads:}
\begin{itemize}
\item{Lisa Komoroske}
\item{Mariana Fuentes}
\item{Will White}
\end{itemize}

\underline{Field work:}
\begin{itemize}
\item{Armando J. B. Santos}
\item{Cintia Miranda}
\item{Blair Bentley}
\item{Estefany Argueta Herrera}
\end{itemize}

\underline{Lab work:}
\begin{itemize}
\item{Estefany Argueta Herrera}
\end{itemize}

