---
title: "Brazil data"
author: "Vic Quennessen"
date: "2025-11-13"
output: pdf_document
header-includes:
  - \usepackage{graphicx}
  - \graphicspath{{figures/}}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo = FALSE, warning = FALSE, message = FALSE}
# load libraries
library(dplyr)
library(readr)
library(ggplot2)
library(tidyverse)
library(patchwork)
library(e1071)
library(fitdistrplus)
library(extraDistr)
library(goft)
library(bbmle)

# load data
# TO DO: edit path to file as needed
BSR_Info_VIC_2025_MaleContribution <- read_csv(
  "~/Projects/iliketurtles3/data/BSR_Info_VIC_2025 - MaleContribution.csv")

# clean up data
clean_data <- BSR_Info_VIC_2025_MaleContribution %>%
  # don't need empty column or notes
  dplyr::select(mom_nest_combo, dad, hatchling_count, NestTotalHatchCount, 
                propdadcontribute, LowNestSampleSize) %>%
  # filter out rows with low nest sample sizes
  filter(LowNestSampleSize == 'No') %>%
  # extract season
  mutate(Season = substring(mom_nest_combo, 10, 11)) %>%
  # extract mom ID
  mutate(Female = substring(mom_nest_combo, 5, 8)) %>%
  # extract nest ID
  mutate(Nest = substring(mom_nest_combo, 13, 16)) 
```

## 1. are all males represented in all clutches of females they mate with in a season?

```{r}
clean_data %>%
  group_by(Season, Female) %>%
  filter(length(unique(Nest)) > 1)
```

Not applicable, no more than one clutch is represented per female per season in the dataset. 

I will therefore assume that all males are represented in all clutches by the same female throughout the same season. 


\newpage
## 2. how many males do females mate with in one season?

In order to more accurately model evolution with maternal and paternal genotypes, I will build a 'breeding pool' of males, where each male will be represented X times, where X is the average number of females that males can mate with, rounded to the nearest integer, dependent upon the mating function. Then, for each female, I need to be able to determine how many males she will mate with to draw that many unique males from the breeding pool. 

```{r, echo = FALSE, results = 'hide'}

males_per_female <- clean_data %>%
  dplyr::select(Season, Female) %>%
  filter(Season != 'S1') %>%
  group_by(Season, Female) %>%
  mutate(nMales = n()) 

round(prop.table(table(males_per_female$nMales)), 2)
#    1    2    3    4    6    7 
# 0.11 0.34 0.15 0.30 0.05 0.06 

summary(males_per_female$nMales) 

# variance
var(males_per_female$nMales)

# standard deviation
sd(males_per_female$nMales)

# skew
skewness(males_per_female$nMales)

# kurtosis ('fatness' of tails)
kurtosis(males_per_female$nMales)
```


\bfseries{Number of males that females mated with in raw data:}


\begin{table}[h]
\begin{tabular}{llllllll}
 Number of males & 1 & 2 & 3 & 4 & 5 & 6 & 7 \\
 \hline
 Number & 13 & 42 & 18 & 36 & 0 & 6 & 7 \\
 Proportion & 0.11 & 0.34 & 0.15 & 0.30 & 0 & 0.05 & 0.06
\end{tabular}
\end{table}


\bfseries{Summary statistics of number of males females mated with:}


\begin{table}[h]
\begin{tabular}{lllllllllll}
 Min & 1st Q & Median & Mean & 3rd Q & Max & Variance & SD & Skew & Kurtosis \\
 \hline
 1.000 & 2.000 & 3.000 & 3.115 & 4.000 & 7.000 & 2.433 & 1.560 & 0.861 & 0.265 \\
\end{tabular}
\end{table}


\bfseries{Density histogram}

```{r, echo = FALSE, fig.height = 4}
ggplot(data = males_per_female, 
       aes(x = nMales)) +
  geom_histogram(aes(y = after_stat(count)/sum(after_stat(count))), 
                 bins = 7, col = 'black', fill = 'cyan3') +
  theme_bw() +
  xlab('\n Number of males females mated with') +
  ylab('Proportion \n') +
  scale_x_continuous(breaks = c(1:7))
```

\newpage
### why fit a model
we can't just use the proportions of females that mated with 1 - 7 males since 
sample sizes are small, and no recorded female mated with 5 males. 

```{r, echo = FALSE, eval = FALSE, warning = FALSE}
# discrete gamma distribution
fit_dgamma <- fitdist(males_per_female$nMales, 'gamma', discrete = TRUE)
summary(fit_dgamma)

# poisson distribution
fit_poisson <- fitdist(males_per_female$nMales, 'pois')
summary(fit_poisson)

# negative binomial distribution
fit_negative_binomial <- fitdist(males_per_female$nMales, 'nbinom')
summary(fit_negative_binomial)

# geometric distribution
fit_geometric <- fitdist(males_per_female$nMales, 'geom')
summary(fit_geometric)
```


#### discrete gamma distribution had the best fit:



\begin{table}[h]
\begin{tabular}{lllll}
 Distribution & Log likelihood & AIC & BIC \\
 discrete gamma & -215.0036 & 434.0071 & 439.6152 \\
 poisson & -223.1883 & 448.3767 & 451.1807 \\
 negative binomial & -223.1884 & 450.3767 & 455.9848 \\
 geometric & -278.3816 & 558.7632 & 561.5673 
\end{tabular}
\end{table}



#### model fit:


```{r, warning = FALSE}

# model with fitted discrete gamma distribution
fit_dgamma <- fitdist(males_per_female$nMales, 'gamma', discrete = TRUE)

# estimates for shape and rate parameters for discrete gamma distribution
summary(fit_dgamma)

# plot data (black) vs. fitted discrete gamma distribution (red)
plot(fit_dgamma)
```


\newpage
#### given this discrete model...

what are the weights for females mating with 1 X males, where X is the maximum number of males we will allow (currently set to 10):

```{r}
# max number of males females can mate with (7 in data)
max_males <- 10

# weighted probabilities for females mating with 1 - 7 males
weightedP <- ddgamma(1:max_males, 
                     shape = fit_dgamma$estimate['shape'], 
                     rate = fit_dgamma$estimate['rate'])

raw_weights <- round(weightedP, 3)
# 0.214 0.283 0.219 0.130 0.065 0.030 0.012

total_sum <- sum(raw_weights)
# 0.9531114

# normalize weights so that they add up to 1
# this assumes we can't have females mating with more than max_males males)
# to adjust this assumption, adjust max_males values 
weights_to_use <- round(weightedP / sum(weightedP), 3)
probability_of_mating_with_n_Males <- data.frame(number_of_males = 1:max_males, 
                                                 probability = weights_to_use)
probability_of_mating_with_n_Males
```

\newpage
## 3. how do males fertilize nests?

```{r, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, results = 'hide'}

contributions <- clean_data %>%
  group_by(Season, Female, Nest) %>%
  mutate(nMales = n()) %>%
  group_by(Season, Female, Nest, nMales) %>%
  mutate(Rank = rank(desc(propdadcontribute), ties.method = 'first'))

contributions <- rbind(contributions, 
                       data.frame(mom_nest_combo = NA, 
                                  dad = NA, 
                                  hatchling_count = NA, 
                                  NestTotalHatchCount = NA, 
                                  propdadcontribute = NA, 
                                  LowNestSampleSize = NA,
                                  Season = NA, 
                                  Female = NA, 
                                  Nest = NA, 
                                  nMales = NA, 
                                  Rank = c(8:10)))

ggplot(data = contributions, 
       aes(x = factor(Rank), 
           y = propdadcontribute,
           fill = factor(nMales))) +
  geom_boxplot() +
  labs(fill = 'total number \n of males \n contributing') +
  ggtitle('Fertilization contributions by Rank (Rank 1 = dominant father)') +
  xlab('Rank')

```


\newpage
#### decaying power law fits very well: \ $y(x) = a \cdot p^{-x}$

Where the intercept = -0.37648 and the log(Rank) = -1.71013: 

```{r}

# turtles work like gravitational waves - jerry sun
# power law
fit_power <- lm(log(propdadcontribute) ~ log(Rank), 
                data = contributions)
summary(fit_power)
```



Model fit is plotted in red points:

```{r, echo = FALSE, warning = FALSE, message = FALSE}
test.power <- data.frame(Rank = 1:max_males, 
                         Fit = exp(fit_power$coefficients[[1]])*c(1:max_males)^(
                           fit_power$coefficients[[2]]))

ggplot(data = contributions, 
       aes(x = factor(Rank), 
           y = propdadcontribute,
           fill = factor(nMales))) +
  geom_boxplot() +
  labs(fill = 'total number \n of males \n contributing') +
  ggtitle('Fertilization contributions by Rank (Rank 1 = dominant father)') +
  geom_point(inherit.aes = FALSE, 
             data = test.power, aes(x = Rank, y = Fit), col = 'red', size = 3) +
  xlab('Rank')
```


\newpage
## 4. how often do males remigrate


#### male remigration interval used in Chapter 2: 1.47 (years)
for green turtle males at Atol das Rocas (Grossman et al., 2019
https://www.int-res.com/abstracts/meps/v609/p197-207/)


#### FdN genetic data

\includegraphics[width=0.5\textwidth]{C://Users/vique/Documents/Projects/iliketurtles3/figures/UpdatedMalePresence.png}


Original data, obtained from Dr. Lisa Komoroske (lkomoroske@umass.edu) on Thursday October 9, 2025. Note: "...Estefany made this upsetR graph for Mariana for an upcoming talk, helps visualize the observed remigration interavl a bit for the males (again, keep in mind the difference in sampling effort in S3 and S4, these will need to be normalized to the number of samples run eventually).


#### fit a binomial model

##### marginalized likelihoods over number of 0 and 1 successes


Given a binomial model, or any resident male green turtle, the probability of seeing it k = 1, 2, 3, or 4 times across n years is equal to:

$$ 
L(k) = \binom{n}{k} \cdot p^k \cdot (1 - p)^{n - k} 
$$

We know that n = 4, since our data were collected over 4 years, giving 4 chances to observe each male. 66 males were observed in season 4, meaning they could have been observed for all previous seasons. We can assume that those males that were observed more than once were residents. For the remaining 44 males, some unknown number of them were residents and others were transient males. For RM1 resident males observed once, there were RM1 + 22 total resident males observed in our dataset. 

Given probability p, the likelihoods of observing RM1 males once, 14 males twice, 7 males 3 times, and 1 male 4 times is the probability of seeing a resident male 1, 2, 3, or 4 times in any given trial of size 4 to the power of the number of times it was observed:

<!-- $$ L(k = 1\ |\ p) = \left( \{4 \choose 1} \cdot p^1 \cdot (1-p)^3 \right)^{RM1} $$ -->
<!-- $$ L(k = 2\ |\ p) = \left( \{4 \choose 2} \cdot p^2 \cdot (1-p)^2 \right)^14 $$ -->
<!-- $$ L(k = 3\ |\ p) = \left( \{4 \choose 3} \cdot p^3 \cdot (1-p)^1 \right)^7 $$ -->
<!-- $$ L(k = 4\ |\ p) = \left( \{4 \choose 4} \cdot p^4 \cdot (1-p)^0 \right)^1 $$ -->

And the total likelihood of seeing all of these is the product of each probability times the number of potential combinations of the order in which they were observed:

<!-- $$ L(data\ |\ RM1,p) = \frac{(RM1 + 14 + 7 + 1)!}{RM1!\,14!\,7!\,1!} \cdot \prod_{k=1}^{k=4} P (k\ |\ RM1, p) $$ -->

The conditional likelihood is then the probability of observing RM1 males once out of all males observed (RM1 + 22) given probability p:

<!-- $$ P(RM1 = 1) = \{RM1 + 22 \choose RM1} \cdot (p(1 - p)^3)^{RM1} \cdot (1 - p(1 - p)^3)^{22} $$ -->

The marginalized likelihood for each value of N is then the likelihood times the conditional likelihood, and the total likelihood for each probability P is equal to the sum of all the marginalized likelihoods across all potential values of N. 

```{r, echo = FALSE, message = FALSE}

analyses <- c('S4 males', 'all males')
total_males <- c(66, 169)
observed234 <- list(c(14, 7, 1), 
                    c(23, 7, 1))

probabilities <- seq(from = 0.1, to = 0.9, by = 0.01)

results <- data.frame(Analysis = rep(analyses, each = length(probabilities)),
                      P = rep(probabilities, times = length(analyses)),
                      Likelihood = rep(NA, 
                                       length(analyses) * length(probabilities)))

for (a in 1:length(analyses)) {
  
  def_resident_males <- sum(observed234[[a]])
  maybe_resident_males <- total_males[a] - def_resident_males
  potential_RM1 <- 1:maybe_resident_males
  
  for (p in 1:(length(probabilities))) {
    
    P <- probabilities[p]
    
    marginalized_likelihoods <- c(NULL)
    
    for (rm1 in potential_RM1) {
      
      # probability of seeing data - observed males seen 2, 3, 4 times, plus some N males seen once
      L1 <- (choose(4, 1) * P^1 * (1 - P)^3)^rm1
      L2 <- (choose(4, 2) * P^2 * (1 - P)^2)^observed234[[a]][1]
      L3 <- (choose(4, 3) * P^3 * (1 - P)^1)^observed234[[a]][2]
      L4 <- (choose(4, 4) * P^4 * (1 - P)^0)^observed234[[a]][3]
      
      L_all <- L1 * L2 * L3 * L4
      
      # factorials for combination
      F1 <- factorial(rm1)
      F2 <- factorial(observed234[[a]][1])
      F3 <- factorial(observed234[[a]][2])
      F4 <- factorial(observed234[[a]][3])
      
      F_all <- F1 * F2 * F3 * F4
      
      likelihood <- factorial(rm1 + def_resident_males)/(F_all) * (L_all)
      
      conditional_likelihood <- choose(rm1 + def_resident_males, rm1) * (
        P*(1 - P)^3)^rm1 * (1 - P*(1 - P)^3)^(def_resident_males)
      
      marginalized_likelihood <- likelihood * conditional_likelihood
      
      marginalized_likelihoods <- c(marginalized_likelihoods, marginalized_likelihood)
      
    }
    
    index <- (a - 1)*length(probabilities) + p
    
    results$Likelihood[index] <- sum(marginalized_likelihoods)
    
  }
  
}

# maximum likelihood binomial probability values
results %>%
  group_by(Analysis) %>%
  filter(Likelihood == max(Likelihood))
         
```


\begin{table}[h]
\begin{tabular}{llll}
 Analysis & Log likelihood & Probability \\
 All males & 0.00000378 & 0.52 \\
 Season 4 males only & 0.000288 & 0.55
\end{tabular}
\end{table}


If we compare the results from analysing only those resident males observed in Season 4 (as opposed to all resident males), the results do not substantially change. The maximum likelihood estimator for P drops from 0.55 to 0.52, but the overall likelihoods are much smaller. 

```{r}

S4P <- results %>%
  filter(Analysis == 'S4 males') %>%
  filter(Likelihood == max(Likelihood)) %>%
  pull(P)

allMP <- results %>%
  filter(Analysis == 'all males') %>%
  filter(Likelihood == max(Likelihood)) %>%
  pull(P) 

to_plot <- results %>%
  mutate(maxL = ifelse(Analysis == 'S4 males', S4P, allMP))

fig_labels <- data.frame(Analysis = c('all males', 'S4 males'), 
                         label = c('P = 0.52', 'P = 0.55'))

ggplot(data = to_plot, 
       aes(x = P, y = Likelihood)) +
  geom_line(aes(x = maxL, y = Likelihood), 
            col = 'blue', lwd = 1) +    
  geom_path(lwd = 1) +
  facet_wrap(vars(Analysis), 
             scales = 'free') +
  xlab('probability of migrating to breeding grounds in any given year') +
  ylab('Likelihood') +
  ggtitle('Maximum likelihood estimation for FdN male probability of migrating') +
  geom_text(data = fig_labels, 
            mapping = aes(x = 0.75, y = Inf, label = label), 
            vjust = 4.5, 
            col = 'blue')

```

The final maximum likelihood estimator for the binomial probability of males mating is therefore p = 0.55, with an associated average remigration interval of 1.82 years. 

